---
title: "Analysis Code"
format: html
---

## Setup

```{r}
## open packages:
library(tidyverse)
library(actuwar)
library(coolorrr)
library(poweRlaw)
library(geomtextpath)
library(ggregtab)

## session options:
data("wars")
set_palette(
  qualitative = c("steelblue", "gray", "red3", "navy", "orange3")
)
theme_set(ggthemes::theme_fivethirtyeight())
theme_update(
  panel.background = element_rect(fill = "white"),
  plot.background = element_rect(fill = "white"), 
  legend.key = element_rect(fill = "white"),
  plot.caption = element_text(
    hjust = 0,
    size = 12
  ),
  plot.subtitle = element_text(
    hjust = .5,
    size = 12
  ),
  plot.caption.position = "plot",
  axis.title = element_text(
    size = 12,
    hjust = .5
  )
)
saveit <- function(num = 1, ht = 4, wd = 6) {
  ggsave(
    filename = here::here(
      "_figs",
      paste0("fig", num, ".png")
    ),
    dpi = 500,
    height = ht,
    width = wd
  )
}
```

## Figure 1

Figure 1 shows variation in war sizes over time.

```{r}
#| fig-height: 4
#| fig-width: 6
ggplot(wars) +
  aes(x = year, y = fat) +
  geom_point() +
  labs(
    x = "Start Year",
    y = "Total Battle Deaths",
    caption = str_wrap(
      "Figure 1: The total number of battle deaths by war in the Correlates of War conflict series. Values shown by war start year.",
      width = 75
    )
  ) +
  scale_x_continuous(
    breaks = seq(1820, 2010, by = 20)
  ) +
  scale_y_continuous(
    labels = ~ paste0(.x / 1e06, " mil")
  )
saveit(1)
```

## Figure 2

To fit the power-law to data I'm using the `{poweRlaw}` R package.

```{r}
## fit the power-law to conflict deaths
pl <- conpl$new(wars$fat)
pl$setXmin(
  estimate_xmin(
    pl, 
    xmax = max(wars$fat)
  )
)
```

Visualize the model:

```{r}
#| fig-height: 4
#| fig-width: 6
p <- function(x) {
  rank(-x) / max(rank(-x))
}
wars |> 
  mutate(
    pfat = p(fat)
  ) |>
  ggplot() +
  aes(fat, pfat) +
  geom_point(
    color = "gray"
  ) +
  geom_smooth(
    data = . %>% 
      filter(fat >= pl$xmin),
    method = "lm",
    se = F
  ) +
  geom_textvline(
    xintercept = pl$xmin,
    label = "Optimal data\nthreshold"
  ) +
  scale_x_log10(
    labels = ~ paste0(
      .x / 1e06, " mil"
    )
  ) +
  scale_y_log10(
    labels = scales::percent
  ) +
  labs(
    subtitle = expression(
      alpha*" = "*1.525*"; x-min = 7,061; data loss = 46.3%"
    ),
    x = "Battle Deaths (in millions)",
    y = "Pr(X > x)",
    caption = str_wrap(
      "Figure 2: The optimal power-law fit for the battle death series. Values are shown on the log-scale.",
      width = 75
    )
  ) 
saveit(2)
```


## Figure 3

The inverse burr fit for the data.

```{r}
base_fit <- ibm(
  outcome = fat,
  data = wars,
  its = 500
)
base_fit$summary |>
  transmute(param, estimate = exp(estimate))
```

Visualize its fit for the data.

```{r}
#| fig-height: 4 
#| fig-width: 6

wars |> 
  mutate(
    pfat = p(fat)
  ) |>
  ggplot() +
  aes(fat, pfat) +
  geom_point(
    color = "gray"
  ) +
  geom_line(
    aes(
      y = actuar::pinvburr(
        q = fat,
        scale = exp(base_fit$summary$estimate[1]),
        shape1 = exp(base_fit$summary$estimate[2]),
        shape2 = exp(base_fit$summary$estimate[3]),
        lower.tail = F
      )
    ),
    color = "blue",
    linewidth = 1
  ) +
  scale_x_log10(
    labels = ~ paste0(
      .x / 1e06, " mil"
    )
  ) +
  scale_y_log10(
    labels = scales::percent
  ) +
  labs(
    subtitle = expression(
      mu*" = 0.49; "*alpha*" = 438.29; "*theta*" = 0.67"
    ),
    x = "Battle Deaths (in millions)",
    y = "Pr(X > x)",
    caption = str_wrap(
      "Figure 3: The optimal inberse Burr fit for the battle death series. Values are shown on the log-scale.",
      width = 75
    )
  ) 
saveit(3)
```



## Figure 4

```{r}
#| fig-height: 4
#| fig-width: 6

px <- function(q = c(0, 10), 
               mu = 2, alpha = 2, theta = 2) {
  tibble(
    x = seq(q[1], q[2], len = 100000),
    y = actuar::dinvburr(
      x = x,
      scale = mu,
      shape1 = alpha,
      shape2 = theta
    )
  )
}

bind_rows(
  px(mu = .5) |> mutate(val = "0.5"),
  px(mu = 1) |> mutate(val = "1"),
  px(mu = 2) |> mutate(val = "2"),
  px(mu = 4) |> mutate(val = "4")
) |>
  ggplot() +
  aes(x, y, color = val) +
  geom_line(linewidth = 1) +
  labs(
    subtitle = expression(alpha*" and "*theta*" held constant at 2"),
    caption = str_wrap(
      "Figure 4: The influence of a change to the scale parameter on the inverse Burr distribution.",
      width = 75
    ),
    x = "x",
    y = "Denisity",
    color = expression(mu*" = ")
  ) +
  ggpal("diverging", ordinal = T, levels = 4)
saveit(4)
```

## Figure 5


```{r}
#| fig-height: 4
#| fig-width: 6

bind_rows(
  px(alpha = .5) |> mutate(val = "0.5"),
  px(alpha = 1) |> mutate(val = "1"),
  px(alpha = 2) |> mutate(val = "2"),
  px(alpha = 4) |> mutate(val = "4")
) |>
  ggplot() +
  aes(x, y, color = val) +
  geom_line(linewidth = 1) +
  labs(
    subtitle = expression(mu*" and "*theta*" held constant at 2"),
    caption = str_wrap(
      "Figure 5: The influence of a change to the first shape parameter on the inverse Burr distribution.",
      width = 75
    ),
    x = "x",
    y = "Denisity",
    color = expression(alpha*" = ")
  ) +
  ggpal("diverging", ordinal = T, levels = 4)
saveit(5)
```


## Figure 6

```{r}
#| fig-height: 4
#| fig-width: 6

bind_rows(
  px(theta = .5) |> mutate(val = "0.5"),
  px(theta = 1) |> mutate(val = "1"),
  px(theta = 2) |> mutate(val = "2"),
  px(theta = 4) |> mutate(val = "4")
) |>
  ggplot() +
  aes(x, y, color = val) +
  geom_line(linewidth = 1) +
  labs(
    subtitle = expression(alpha*" and "*mu*" held constant at 2"),
    caption = str_wrap(
      "Figure 6: The influence of a change to the second shape parameter on the inverse Burr distribution.",
      width = 75
    ),
    x = "x",
    y = "Denisity",
    color = expression(theta*" = ")
  ) +
  ggpal("diverging", ordinal = T, levels = 4)
saveit(6)
```

## Figure 7

```{r}
#| fig-height: 4
#| fig-width: 6

llplot(wars, fat) +
  labs(
    caption = str_wrap(
      "Figure 7: A log-log plot of Pr(X > x) given x for battle deaths in the CoW war series produced using llplot() from the {actuwar} R package.",
      width = 75
    )
  )
saveit(7)
```

## Figure 8

```{r}
#| fig-height: 4.5
#| fig-width: 6

llplot(wars, fat, by = post1950) +
  labs(
    caption = str_wrap(
      "Figure 8: A log-log plot of Pr(X > x) given x for battle deaths in the CoW war series produced using llplot() from the {actuwar} R package. Output is grouped by whether a war started before or after 1950.",
      width = 75
    )
  )
saveit(8, 4.5, 6)
```

## Figure 9

```{r}
#| fig-height: 4.5
#| fig-width: 6

llplot(wars, fat, by = post1950, show_fit = T) +
  labs(
    caption = str_wrap(
      "Figure 9: A log-log plot with inverse Burr fits of Pr(X > x) given x for battle deaths in the CoW war series produced using llplot() from the {actuwar} R package. Output is grouped by whether a war started before or after 1950.",
      width = 75
    )
  )
saveit(9, 4.5, 6)
```

## Table 1

With covariates.

```{r}
library(furrr)
cores <- availableCores() - 1
plan(multisession, workers = cores)
wars$post1950 <- ifelse(wars$post1950 == "post-1950", 1, 0)
wars$post1950 <- ifelse(wars$post1950 == 1, "post-1950", "pre-1950")
preds <- ~ post1950 + dem + pop
cov_fit <- ibm(
  fat,
  mu = preds,
  alpha = preds,
  theta = preds,
  data = wars
)
cov_fit$summary
```


```{r}
#| fig-height: 4
#| fig-width: 6
bind_rows(
  base_fit$summary |> mutate(model = "Baseline"),
  cov_fit$summary |> mutate(model = "Covariates")
) |>
  mutate(
    conf.low = estimate - 1.96 * std.error,
    conf.high = estimate + 1.96 * std.error,
    N = 95
  ) |>
  ggregtab(ratio = .75) +
  facet_wrap(
    ~ paste0("log(",param,")"),
    labeller = label_parsed
  ) +
  scale_y_discrete(
    labels = c("Population (log)", "Polity (Avg.)", "Pre-1950",
               "Constant")
  ) +
  labs(
    subtitle = str_wrap(
      "Table 1: Inverse Burr regression estimates with bootstrapped standard errors.",
      width = 80
    )
  )
saveit("_regtab")
```


## Figure 10

```{r}
set.seed(1)
ibm_sim(
  cov_fit,
  newdata = tibble(
    dem = mean(wars$dem),
    pop = range(wars$pop),
    post1950 = "post-1950"
  ),
  se = T
) -> cov_sim

llplot(cov_sim, pred, by = as.factor(pop)) +
  labs(
    caption = str_wrap(
      "Figure 10: Simulated Pr(X > x) for war deaths conditional on belligerent population, controlling for democracy and period.",
      width = 75
    ),
    color = "Belligerent Population (millions):",
    x = "Simulated Battle Deaths (millions)"
  ) +
  ggpal(
    labels = c("1.14", "1,349.9")
  ) +
  scale_x_log10(
    labels = ~ scales::comma(.x / 1e06)
  ) +
  scale_y_log10(
    labels = scales::percent
  ) 

saveit(10)
```

## Figure 11

```{r}
#| fig-height: 4
#| fig-width: 6
cov_sim |>
  group_by(pop) |>
  boot_p(pred, thresh = 16e06, ci = .834) -> sim_p

ggplot(sim_p) +
  aes(c("1.14", "1,349.9"), estimate, ymin = boot_lower, ymax = boot_upper) +
  geom_pointrange() +
  labs(
    caption = str_wrap(
      "Figure 11: The chance of a war larger than WWII is significantly higher when belligerents have larger populations. Point estimate shown with 83.4% confidence intervals.",
      width = 75
    ),
    x = "\nBelligerent Population (millions)\n",
    y = "Pr(Deaths > 16 million)\n"
  )
saveit(11)
```



## Figure 8

Show the conditional effect of democracy

```{r}
#| fig-height: 4
#| fig-width: 6

ibm_sim(
  cov_fit,
  newdata = tibble(
    post1950 = mean(wars$post1950),
    dem = c(-10, 0, 10),
    pop = mean(wars$pop)
  )
) -> dem_sim

dem_sim |>
  group_by(dem) |>
  mutate(ppred = p(pred)) |>
  ggplot() +
  aes(pred, ppred, color = as.factor(dem)) |>
  geom_point(alpha = 0.4) +
  scale_x_log10(
    labels = ~ paste0(.x / 1e06, " mil")
  ) +
  scale_y_log10(
    labels = scales::percent
  ) +
  ggpal() +
  labs(
    caption = str_wrap(
      "Figure 8: The conditional impact of average polity scores among belligerents on the CDF of war fatalities.",
      width = 75
    ),
    x = "Battle Deaths (in millions)",
    y = "Pr(X > x)",
    color = "Mean Polity"
  )
saveit(8)
```

## Table 2

```{r}
cov_fit0 <- ibm(
  fat,
  mu = preds,
  alpha = preds,
  theta = preds,
  data = wars |> mutate(fat = fat - 999) |>
    mutate(fat = ifelse(fat == 1, 1:sum(fat == 1), fat))
)
```


```{r}
#| fig-height: 4
#| fig-width: 6
bind_rows(
  cov_fit$summary |> mutate(model = "(1)"),
  cov_fit0$summary |> mutate(model = "(2)")
) |>
  mutate(
    conf.low = estimate - 1.96 * std.error,
    conf.high = estimate + 1.96 * std.error,
    N = 95
  ) |>
  ggregtab(ratio = .75) +
  facet_wrap(
    ~ paste0("log(",param,")"),
    labeller = label_parsed
  ) +
  scale_y_discrete(
    labels = c("Population (log)", "Polity (Avg.)", "Pre-1950",
               "Constant")
  ) +
  labs(
    subtitle = str_wrap(
      "Table 2: Inverse Burr regression estimates with bootstrapped standard errors. Unadjusted fatality totals (1) compared with adjusted fatalities (2) as the outcome.",
      width = 80
    )
  )
saveit("_regtab2")
```


## Tabulations reported in-text

The share of all war deaths the top wars are responsible for.

```{r}
wars |>
  mutate(
    pct = fat / sum(fat)
  ) |>
  arrange(-pct) |>
  mutate(
    cumpct = cumsum(pct)
  )
```

